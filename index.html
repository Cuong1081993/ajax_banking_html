<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="assets/bootstrap/v5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fontawesome/v5.15.4/css/all.min.css">
    <link rel="stylesheet" href="assets/sweetalert2/v11.7.0/sweetalert2.all.min.js">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="container-fluid mt-2">
        <header>
            <div class="col-lg-12">
                <div class="col-lg-6 float-start">
                    <h1> LIST OF CUSTOMER</h1>
                </div>
                <div class="col-lg-6 float-start text-right">
                    <a href="/histories/transfers">
                        <button class="btn btn-outline-light">
                            <i class="fa fa-bars"></i>
                            Transfer History
                        </button>
                    </a>
                    <button type="button" class="btn btn-outline-light" id="btnShowCreateModal">
                        <i class="fa fa-plus"></i>
                        Create New Customer
                    </button>
                </div>
            </div>
        </header>
        <div class="content-page">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center">Full Name</th>
                        <th class="text-center">Email</th>
                        <th class="text-center">Phone</th>
                        <th class="text-center">Address</th>
                        <th class="text-center">Province</th>
                        <th class="text-center">District</th>
                        <th class="text-center">Ward</th>
                        <th class="text-center">Balance</th>
                        <th colspan="5" style="text-align: center;">Action</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <!-- MODAL CREATE -->
        <div class="modal fade" id="modalCreateCustomer" data-bs-backdrop="static" data-bs-keyboard="false"
            tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5"> Create Customer</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-alert-danger hide">

                        </div>
                        <form id="frmCreate" method="post">
                            <div class="row mt-3">
                                <div class="col-sm-6">
                                    <label>Full Name</label>
                                    <input type="text" name="fullNameCre" id="fullNameCre" class="form-control">
                                </div>
                                <div class="col-sm-6">
                                    <label>Phone</label>
                                    <input type="tel" name="phoneCre" id="phoneCre" class="form-control">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-lg-4">
                                    <label>Province</label>
                                    <select class="form-select" id="provinceCre"></select>
                                </div>
                                <div class="col-lg-4">
                                    <label>District</label>
                                    <select class="form-select" id="districtCre"></select>
                                </div>
                                <div class="col-lg-4">
                                    <label>Ward</label>
                                    <select class="form-select" id="wardCre"></select>
                                </div>
                                <div class="col-sm-6">
                                    <label>Address</label>
                                    <input type="text" name="addressCre" id="addressCre" class="form-control">
                                </div>
                                <div class="col-sm-6">
                                    <label>Email</label>
                                    <input type="email" name="emailCre" id="emailCre" class="form-control">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer p-lg-2">
                        <button type="button" class="btn btn-outline-primary m-3" id="btnCreate">
                            <i class="fa fa-plus"></i>
                            Create
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END MODAL CREATE -->


        <!-- MODAL UPDATE -->
        <div class="modal fade" id="modalUpdate" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title"> Update Customer</h1>
                        <button type="button" class="btn-close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="frmUpdateCustomer" method="post">
                            <div class="row mt-3">
                                <div class="col-sm-6">
                                    <label>Full Name</label>
                                    <input type="text" name="fullNameUp" id="fullNameUp" class="form-control">
                                </div>
                                <div class="col-sm-6">
                                    <label>Email</label>
                                    <input type="email" name="emailUp" id="emailUp" class="form-control">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-sm-6">
                                    <label>Phone</label>
                                    <input type="tel" name="phoneUp" id="phoneUp" class="form-control">
                                </div>
                                <div class="col-sm-6">
                                    <label>Address</label>
                                    <input type="text" name="addressUp" id="addressUp" class="form-control">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer p-lg-2">
                        <button type="button" class="btn btn-outline-primary m-3" id="btnUpdate">
                            <i class="fa fa-pencil-alt"></i>
                            Update
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!--  END MODAL UPDATE -->

        <!-- MODAL DEPOSIT -->
        <div class="modal fade" id="modalDeposit" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Modal deposit</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post">
                            <div class="row mt-3">
                                <div class="col-lg-6">
                                    <label>Customer ID</label>
                                    <input type="text" class="form-control" id="idDep" readonly />
                                </div>
                                <div class="col-lg-6">
                                    <label>Full Name</label>
                                    <input type="text" class="form-control" id="fullNameDep" readonly />
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-lg-6">
                                    <label>Balance</label>
                                    <input type="text" class="form-control" id="balanceDep" readonly />
                                </div>
                                <div class="col-lg-6">
                                    <label>Transaction Amount</label>
                                    <input type="text" class="form-control" id="transactionAmountDep" />
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btnDeposit" class="btn btn-outline-success">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END MODAL DEPOSIT -->

        <!-- Modal Transfer -->
        <div class="modal fade" id="modalTransfer" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Modal transfer</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="frmTransfer" method="post">
                            <fieldset class="mt-3 g-3">
                                <div class="form-group row">
                                    <div class="mb-3 col-md-4">
                                        <label class="col-sm-12 col-form-label">Sender ID</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control" id="senderId" name="senderIdTrf"
                                                readonly>
                                        </div>
                                    </div>
                                    <div class="mb-3 col-md-4">
                                        <label class="col-sm-12 col-form-label">Sender Name</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control" id="senderName" name="senderNameTrf"
                                                readonly>
                                        </div>
                                    </div>
                                    <div class="mb-3 col-md-4">
                                        <label class="col-sm-12 col-form-label">Phone</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control" id="senderPhone" name="phoneTrf"
                                                readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="mb-3 col-md-6">
                                        <label class="col-sm-12 col-form-label">Sender balance</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control num-space" id="senderBalance"
                                                name="balanceTrf" readonly>
                                        </div>
                                    </div>

                                    <div class="mb-3 col-md-6">
                                        <label class="col-sm-12 col-form-label">Recipient Name</label>
                                        <div class="col-sm-12">
                                            <select class="form-select" id="recipientTrf" name="recipientTrf"></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="mb-3 col-md-4">
                                        <label class="col-sm-12 col-form-label">Transfer Amount ($)</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control num-space" id="transferAmountTrf"
                                                name="transferAmountTrf">
                                        </div>
                                    </div>
                                    <div class="mb-3 col-md-4">
                                        <label class="col-sm-12 col-form-label">Fees (%)</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control num-space" id="feesTrf"
                                                name="feesTrf" value="10" readonly>
                                        </div>
                                    </div>
                                    <div class="mb-3 col-md-4">
                                        <label class="col-sm-12 col-form-label">Total amount of transaction ($)</label>
                                        <div class="col-sm-12">
                                            <input type="text" class="form-control num-dot" id="transactionAmountTrf"
                                                name="transactionAmountTrf" readonly>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btnTransfer" class="btn btn-outline-primary">
                            <i class="fas fa-exchange-alt"></i>
                            Transfer
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!--  END Modal Transfer -->


    </div>
    <script src="assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="assets/jquery/v3.6.3/jquery-3.6.3.min.js"></script>
    <script src="assets/js/appBase.js"></script>
    <script src="assets/sweetalert2/v11.7.0/sweetalert2.all.min.js"></script>
    <script>

        const page = {
            urls: {
                getAllCustomers: AppBase.API_CUSTOMER,
                findCustomerById: AppBase.API_CUSTOMER,
                doCreate: AppBase.API_CUSTOMER,
                insertDeposit: AppBase.API_DEPOSIT,
                insertTransfer: AppBase.API_TRANSFER,
                incrementBalance: AppBase.API_CUSTOMER,
                decrementBalance: AppBase.API_CUSTOMER
            },
            elements: {},
            loadData: {},
            commands: {},
            dialogs: {
                elements: {},
                commands: {},
                loadData: {}
            }
        }

        page.loadData.getAllCustomers = () => {
            $.ajax({
                type: 'GET',
                url: page.urls.getAllCustomers + '?deleted=0'
            })
                .done((data) => {
                    $.each(data, (i, customers) => {
            
                        let str = renderCustomer(customers);
                        $('table tbody').prepend(str);
                    })
                    addEventUpdateClick();
                    addEventDeleteClick();
                    addEventDepositClick();
                    addEventTransferClick();


                })
                .fail(error => {
                    console.log(error);
                })
        }



        let currentCustomerId;
        page.elements.btnCreate = $('#btnCreate');
        page.elements.btnUpdate = $('#btnUpdate');
        page.elements.btnDeposit = $('#btnDeposit');
        page.elements.btnTransfer = $('#btnTransfer');

        page.dialogs.elements.modalCreate = $('#modalCreate');
        page.dialogs.elements.fullNameCre = $('#fulNameCre');
        page.dialogs.elements.phoneCre= $('#phoneCre');
        page.dialogs.elements.emailCre = $('#emailCre');
        page.dialogs.elements.provinceCre = $('#provinceCre');
        page.dialogs.elements.districtCre = $('#districtCre');
        page.dialogs.elements.wardCre = $('#wardCre');
        page.dialogs.elements.addressCre = $('#addressCre');
        
        

        page.dialogs.elements.modalUpdate = $('#modalUpdate');
        page.dialogs.elements.modalDeposit = $('#modalDeposit');


        page.dialogs.elements.modalTransfer = $('#modalTransfer');
        page.dialogs.elements.frmTransfer = $('#frmTransfer');
        page.dialogs.elements.senderId = $('#senderId');
        page.dialogs.elements.senderName = $('#senderName');
        page.dialogs.elements.senderPhone = $('#senderPhone');
        page.dialogs.elements.senderBalance = $('#senderBalance');
        page.dialogs.elements.recipientTrf = $('#recipientTrf');
        page.dialogs.elements.transferAmountTrf = $('#transferAmountTrf');
        page.dialogs.elements.feesTrf = $('#feesTrf');
        page.dialogs.elements.transactionAmountTrf = $('#transactionAmountTrf');
        page.dialogs.elements.btnTransfer = $('#btnTransfer');

        page.loadData.getAllProvinces = () => {
            $.ajax({
                type: "GET",
                url: "https://vapi.vnappmob.com/api/province/"
            })
                .done((data) => {
                    $.each(data.results, (i, item) => {
                        let str = `<option value ='${item.province_id}'>${item.province_name}</option>`;
                        $('#provinceCre').append(str);
                    })
                    let str = `<option value="0" selected>-- Please selected --</option>`;
                    $('#provinceCre').prepend(str);


                    page.commands.addEventChangeProvince();

                })
                .fail((error) => {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: "Can't get all provinces"
                    })
                })
        }
        
        page.commands.addEventChangeProvince = () => {
            let removed = false;

            page.dialogs.elements.provinceCre.on('change', function () {
                $('#wardCre').empty();

                let str = `<option value="0" selected>-- Please selected --</option>`;
                $('#wardCre').prepend(str);

                let provinceId = $(this).val();
                if (provinceId !== 0) {
                    if (!removed) {
                        $('#provinceCre option')[0].remove();
                        removed = !removed;
                    }
                    page.loadData.getAllDistrictsByProvinceId(provinceId);
                }
            })
        }

        page.loadData.getAllDistrictsByProvinceId = (provinceId) => {
            $.ajax({
                type: "GET",
                url: "https://vapi.vnappmob.com/api/province/district/" + provinceId
            })
                .done((data) => {

                    $('#districtCre').empty();

                    $.each(data.results, (i, item) => {
                        let str = `<option value ='${item.district_id}'>${item.district_name}</option>`;
                        $('#districtCre').append(str);
                    })
                    let str = `<option value="0" selected>-- Please selected --</option>`;
                    $('#districtCre').prepend(str);

                    page.commands.addEventChangeDistrict();

                })
                .fail((error) => {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: "Can't get all provinces"
                    })
                })
        }

        page.commands.addEventChangeDistrict = () => {
            let removed = false;

            $('#districtCre').on('change', function () {
                let districtId = $(this).val();
                if (districtId !== 0) {
                    if (!removed) {
                        $('#districtCre option')[0].remove();
                        removed = !removed;
                    }
                    page.loadData.getAllWardsByDistrictId(districtId);
                }
            })
        }

        page.loadData.getAllWardsByDistrictId = (districtId) => {
            $.ajax({
                type: "GET",
                url: "https://vapi.vnappmob.com/api/province/ward/" + districtId
            })
                .done((data) => {

                    $('#wardCre').empty();

                    $.each(data.results, (i, item) => {
                        let str = `<option value ='${item.ward_id}'>${item.ward_name}</option>`;
                        $('#wardCre').append(str);
                    })
                    let str = `<option value="0" selected>-- Please selected --</option>`;
                    $('#wardCre').prepend(str);

                })
                .fail((error) => {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: "Can't get all provinces"
                    })
                })
        }

        page.commands.doCreate = () => {
            let fullName = $('#fullNameCre').val();
            let email = $('#emailCre').val();
            let phone = $('#phoneCre').val();
            let provinceId = $('#provinceCre').val;
            let provinceName = $('#provinceCre').find('option:selected').text();
            let districtId = $('#districtCre').val();
            let districtName = $('#districtCre').find('option:selected').text();
            let wardId = $("#wardCre").val();
            let wardName = $("#wardCre").find("option:selected").text();
            let address = $('#addressCre').val();
            let balance = 0;
            let deleted = 0;
            let locationRegion = {
                provinceId,
                provinceName,
                districtId,
                districtName,
                wardId,
                wardName,
                address
            }

            let customer = {
                fullName,
                email,
                phone,
                locationRegion,
                balance,
                deleted
            }
            console.log(customer);
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.urls.doCreate,
                data: JSON.stringify(customer)
            })
                .done((data) => {

                     customer = data;
                     $("#modalCreate").modal("hide");
                    let str = renderCustomer(data);
                    $('table tbody').prepend(str);

                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Create Customer Successfully',
                        showConfirmButton: false,
                        timer: 2000
                    })
                    
                })
                .fail((error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Create Customer went wrong!',
                    })
                })
        }

        page.commands.doDeposit = () => {
            let customerId = +$('#idDep').val();

            page.loadData.findCustomerById(customerId).then((customer) => {
                let currentBalance = customer.balance;
                let transactionAmount = +$('#transactionAmountDep').val();

                let newBalance = currentBalance + transactionAmount;

                let depObj = {
                    customerId,
                    transactionAmount
                }

                page.commands.insertDeposit(depObj).then((data) => {
                    let customerObj = {
                        balance: newBalance
                    }
                    page.commands.incrementBalance(customerId, customerObj).then((data) => {

                        console.log(data);
                        let str = renderCustomer(data);
                        $('#tr_' + customerId).replaceWith(str);

                        $('.update').off('click');
                        $('.delete').off('click');
                        $('.deposit').off('click');
                        $('.transfer').off('click');

                        addEventUpdateClick();
                        addEventDeleteClick();
                        addEventDepositClick();
                        addEventTransferClick();
                        Swal.fire({
                            position: 'center',
                            icon: 'success',
                            title: 'Deposit Successfully',
                            showConfirmButton: false,
                            timer: 2000
                        })
                        $('#transactionAmountDep').val('');
                        $('#modalDeposit').modal('hide');
                    })
                })
            })
        }

        page.commands.doTransfer = () => {
            let senderId = +page.dialogs.elements.senderId.val();
            let recipientId = page.dialogs.elements.recipientTrf.val();
            let transferAmount = +page.dialogs.elements.transferAmountTrf.val();
            let fees = 10;
            let feesAmount = transferAmount * fees / 100;
            let transactionAmount = transferAmount + feesAmount;

            if (senderId === recipientId) {
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: 'Recipient not valid',
                    showConfirmButton: true
                })
                return;
            }


            page.loadData.findCustomerById(senderId).then((sender) => {

                let currentSenderBalance = sender.balance;
                if (currentSenderBalance < transactionAmount) {

                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Sender balance not enough to proccess transfer',
                        showConfirmButton: true
                    })
                    return;
                }
                page.loadData.findCustomerById(recipientId).then((recipient) => {
                    console.log(recipient);
                    let trsObj = {
                        senderId,
                        recipientId,
                        transferAmount,
                        fees,
                        feesAmount,
                        transactionAmount
                    }
                    page.commands.insertTransfer(trsObj);

                    let newSenderBalance = currentSenderBalance - transactionAmount;
                    let senderObj = {
                        balance: newSenderBalance
                    }
                    page.commands.decrementBalance(senderId, senderObj).then((sender) => {
                        let currentSenderRow = $('#tr_' + senderId);
                        let newSenderRow = renderCustomer(sender);
                        currentSenderRow.replaceWith(newSenderRow);
                        $('.update').off('click');
                        $('.delete').off('click');
                        $('.deposit').off('click');
                        $('.transfer').off('click');

                        addEventUpdateClick();
                        addEventDeleteClick();
                        addEventDepositClick();
                        addEventTransferClick();
                    });

                    let currentRecipientBalance = recipient.balance;
                    let newRecipientBalance = currentRecipientBalance + transferAmount;
                    let recipientObj = {
                        balance: newRecipientBalance
                    }

                    page.commands.incrementBalance(recipientId, recipientObj).then((recipient) => {
                        let currentRecipientRow = $('#tr_' + recipientId);
                        let newRecipientRow = renderCustomer(recipient);
                        currentRecipientRow.replaceWith(newRecipientRow);
                        $('.update').off('click');
                        $('.delete').off('click');
                        $('.deposit').off('click');
                        $('.transfer').off('click');

                        addEventUpdateClick();
                        addEventDeleteClick();
                        addEventDepositClick();
                        addEventTransferClick();
                    });


                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Transfer has been saved',
                        showConfirmButton: false,
                        timer: 2000
                    })
                    $('#transactionAmountTrf').val('');
                    page.dialogs.elements.modalTransfer.modal('hide');
                })
                    .catch(() => {
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Recipient not valid',
                            showConfirmButton: true
                        })
                    })
                    .catch(() => {
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Sender not valid',
                            showConfirmButton: true
                        })
                    })
            })
        }

        page.commands.insertDeposit = (depObj) => {
            return $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.urls.insertDeposit,
                data: JSON.stringify(depObj)
            })
                .fail((error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Deleted  went wrong !',
                    })
                })
        }

        page.commands.insertTransfer = (trsObj) => {
            return $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.urls.insertTransfer,
                data: JSON.stringify(trsObj)
            })
                .fail((error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Transfer  went wrong !',
                    })
                })
        }

        page.commands.incrementBalance = (customerId, customerObj) => {
            return $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.urls.incrementBalance + '/' + customerId,
                data: JSON.stringify(customerObj)
            })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.commands.decrementBalance = (customerId, customerObj) => {
            return $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.urls.decrementBalance + '/' + customerId,
                data: JSON.stringify(customerObj)
            })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.commands.addEventChangeTransferAmount = () => {
            let transferAmountElem = page.dialogs.elements.transferAmountTrf;
            transferAmountElem.on('input', function () {

                let transferAmount = +transferAmountElem.val();
                let fees = 10;
                let feesAmount = transferAmount * fees / 100;
                let transactionAmount = transferAmount + feesAmount;
                page.dialogs.elements.transactionAmountTrf.val(transactionAmount);
            })
        }

        page.elements.btnUpdate.on('click', () => {

            let fullName = $('#fullNameUp').val();
            let email = $('#emailUp').val();
            let phone = $('#phoneUp').val();
            let address = $('#addressUp').val();
            let balance = 0;

            let obj = {
                fullName,
                email,
                phone,
                address
            }

            page.loadData.findCustomerById(currentCustomerId).then((data) => {
                // console.log(data);
                $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'PATCH',
                    url: 'http://localhost:3300/customers/' + currentCustomerId,
                    data: JSON.stringify(obj)
                })
                    .done((data) => {
                        let str = renderCustomer(data);
                        $('#tr_' + currentCustomerId).replaceWith(str);

                        $('.edit').off('click');
                        $('.delete').off('click');

                        addEventUpdateClick();
                        addEventDeleteClick();

                        Swal.fire({
                            position: 'center',
                            icon: 'success',
                            title: 'Update Successfully',
                            showConfirmButton: false,
                            timer: 2000
                        })
                        $('#modalUpdate').modal('hide');
                    })
                    .fail((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Update  went wrong!',
                        })
                    })
            })
        })

        function renderCustomer(item) {
            return `
                <tr id="tr_${item.id}">
                    <td class="text-center">${item.id}</td>
                    <td class="text-center">${item.fullName}</td>
                    <td class="text-center">${item.email}</td>
                    <td class="text-center">${item.phone}</td>
                    <td class="text-center">${item.locationRegion.address}</td>
                    <td>${item.locationRegion.provinceName}</td>
                    <td>${item.locationRegion.districtName}</td>
                    <td>${item.locationRegion.wardName}</td>
                    <td class="text-end">${item.balance}</td>
                    <td style ="width : 2%">
                        <button class="btn btn-outline-secondary update" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" title="Update" id="btnUpdate">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                    <td style ="width : 2%">
                        <button class="btn btn-outline-success deposit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" title="Deposit">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                    <td style ="width : 2%">
                        <button class="btn btn-outline-warning withdraw"  data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" title="WithDraw">
                            <i class="fas fa-minus"></i>
                        </button>
                    </td>
                    <td style ="width : 2%">
                        <button class="btn btn-outline-primary transfer" data-sender-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" title="Transfer">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </td>
                    <td style ="width : 2%">
                        <button class="btn btn-outline-danger delete" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" title="Suppened">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        page.loadData.findCustomerById = (id) => {
            return $.ajax({
                type: 'GET',
                url: page.urls.findCustomerById + '/' + id
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function addEventUpdateClick() {
            $('.update').on('click', function () {

                let customerId = $(this).data('id');
                page.loadData.findCustomerById(customerId).then((customer) => {

                    currentCustomerId = customerId;
                    $('#fullNameUp').val(customer.fullName);
                    $('#emailUp').val(customer.email);
                    $('#phoneUp').val(customer.phone);
                    $('#addressUp').val(customer.address);

                    $('#modalUpdate').modal('show');
                })
                    .catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Customer is Invalid!',
                        })
                    })
            })
        }

        function addEventDeleteClick() {
            $('.delete').on('click', function () {
                let customerId = $(this).data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                })
                    .then((result) => {

                        if (result.isConfirmed) {
                            console.log("dopne");
                            let customer = {
                                deleted: 1
                            }
                            $.ajax({
                                headers: {
                                    "accept": "application/json",
                                    "content-type": "application/json"
                                },
                                type: "PATCH",
                                url: "http://localhost:3300/customers/" + customerId,
                                data: JSON.stringify(customer)
                            })
                                .done((data) => {
                                    $('#tr_' + customerId).remove();
                                     
                                    Swal.fire({
                                        position: 'center',
                                        icon: 'success',
                                        title: 'Delete customer successful',
                                        showConfirmButton: false,
                                        timer: 50000
                                    })
                                })
                                .fail((error) => {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: 'Deleted  went wrong !',
                                    })
                                })
                        }
                    })
            })
        }

        function addEventDepositClick() {
            $('.deposit').on('click', function () {

                let customerId = $(this).data('id');
                page.loadData.findCustomerById(customerId).then((customer) => {

                    $('#idDep').val(customer.id);
                    $('#fullNameDep').val(customer.fullName);
                    $('#balanceDep').val(customer.balance);

                    $('#modalDeposit').modal('show');
                })
                    .catch(() => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: ' Customer is Invalid !',
                        })
                    })
            })
        }

        function addEventTransferClick() {
            $('.transfer').on('click', function () {
                let senderId = $(this).data('sender-id');
                page.loadData.findCustomerById(senderId).then((sender) => {

                    page.loadData.getAllRecipients(senderId);
                    page.dialogs.elements.senderId.val(sender.id);
                    page.dialogs.elements.senderName.val(sender.fullName);
                    page.dialogs.elements.senderPhone.val(sender.phone);
                    page.dialogs.elements.senderBalance.val(sender.balance);

                    page.dialogs.elements.modalTransfer.modal('show');
                })
            })
        }

        function renderRecipientOption(obj) {
            return `
            <option value="${obj.id}">(${obj.id}) -${obj.fullName}</option>
            `
        }

        $("#modalCreateCustomer").on("hidden.bs.modal", () => {
            $("#frmCreate")[0].reset();
        })

        $("#btnShowCreateModal").on("click", () => {
            $("#modalCreateCustomer").modal("show");
        })

        page.loadData.getAllRecipients = (senderId) => {
            $.ajax({
                type: 'GET',
                url: page.urls.getAllCustomers + '?id_ne=' + senderId
            })
                .done((data) => {
                    page.dialogs.elements.recipientTrf.empty();

                    $.each(data, (i, item) => {
                        let str = renderRecipientOption(item);
                        page.dialogs.elements.recipientTrf.append(str);
                    })
                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.commands.loadData = () => {
            page.loadData.getAllCustomers();
            page.loadData.getAllProvinces();

        }

        page.initializeControlEvent = () => {
            page.elements.btnCreate.on('click', function () {
                page.commands.doCreate();
            });

            page.elements.btnDeposit.on('click', function () {
                page.commands.doDeposit();
            });

            page.elements.btnTransfer.on('click', function () {
                page.commands.doTransfer();
            });

            page.commands.addEventChangeTransferAmount();
        }

        $(() => {
            page.commands.loadData();
            page.initializeControlEvent();
        })

    </script>
</body>

</html>